
```{r setup}
library(compr)
library(tidyverse)
library(broom)
```

```{r}

#nba_game<-load("data/nba_game.rda")
combined_df
comp_mod <- comp_glm(home_winner ~ 1, data = combined_df,
                     p1 = "home", p2 = "away",
                     #p1_effects = ~ point_server1,
                     #p2_effects = ~ point_server2,
                     ref_player = "Denver Nugets"
                     )

```

```{r}
coefficients <- comp_mod$coefficients
# this is the bump for the home team
coefficients <- coefficients[-1]

coefficients <- coefficients[1:8]
names <- names(coefficients)

win_probability <- function(player, coefficients, reference_player) {
  #linear_combination <- coefficients[player] - coefficients[reference_player]
  win_probability <- 1 / (1 + exp(-coefficients[player]))
  return(win_probability)
}

df <- data.frame(Name = character(0), Prob = numeric(0))

for (name in names) {
  prob <- win_probability(name, coefficients, reference_player)
  new_row <- data.frame(Name = name, Prob = round(prob * 100, 2))
  df <- rbind(df, new_row)
}
rownames(df) <- NULL

#fct_reorder
df$Name <- reorder(df$Name, -df$Prob)

ggplot(df, aes(x = Name, y = Prob)) +
  geom_segment(aes(xend = Name, yend = 0)) +
  geom_point(size =3) +
  labs(title = "Lolipop of Win Probability Against the Boston Celtics", x = "Team Name", y = "Win Probability (%)") +
  theme_bw()
```


```{r}
#trying to put it into a function
comp_mod$data$ref_player

lolipop_prob <- function(model){
    coefficients <- model$coefficients
    coefficients <- coefficients[-1]
    names <- names(coefficients)
  
  win_probability <- function(player, coefficients, reference_player) {
    #linear_combination <- coefficients[player] - coefficients[reference_player]
    win_probability <- 1 / (1 + exp(coefficients[player]))
    return(win_probability)
  }
  
  df <- data.frame(Name = character(0), Prob = numeric(0))
  
  for (name in names) {
    prob <- win_probability(name, coefficients, reference_player)
    new_row <- data.frame(Name = name, Prob = round(prob * 100, 2))
    df <- rbind(df, new_row)
  }
  rownames(df) <- NULL
  

df <- df %>%
  arrange(desc(Prob)) %>%
  mutate(Name = fct_reorder(Name, -Prob))
  
  ggplot(df, aes(x = Name, y = Prob)) +
    geom_segment(aes(xend = Name, yend = 0)) +
    geom_point(size =3) +
    labs(title = paste("Lollipop of the", comp_mod$data$ref_player,"Win Probability"), x = "Name", y = "Win Probability (%)") +
    theme_bw() +
    coord_flip()
    
}

lolipop_prob(comp_mod)

#make a function with model as argument 
augment_test <- augment(comp_mod)
```


